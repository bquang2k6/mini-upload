<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mini Google Drive - Mobile Optimized</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
  <style>
/* Base styles và desktop */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  background: #f8f9fa;
  font-size: 14px;
}

.drive-header {
  background: #fff;
  border-bottom: 1px solid #e0e0e0;
  padding: 16px 24px;
  display: flex;
  align-items: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-title {
  font-size: 22px;
  font-weight: 400;
  color: #202124;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.main-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
}

/* Upload Progress Bar - Improved */
.upload-progress-container {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1001;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(8px);
  padding: 12px 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transform: translateY(-100%);
  transition: transform 0.3s ease-out;
}

.upload-progress-container.show {
  transform: translateY(0);
}

.upload-progress-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.upload-progress-title {
  font-weight: 500;
  color: #1a73e8;
  display: flex;
  align-items: center;
  gap: 8px;
}

.upload-progress-close {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #5f6368;
  padding: 4px;
  border-radius: 50%;
  transition: background-color 0.2s;
}

.upload-progress-close:hover {
  background: #f1f3f4;
}

.upload-progress-bar {
  height: 6px;
  background: #e8eaed;
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}

.upload-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #1a73e8, #4285f4);
  border-radius: 3px;
  transition: width 0.3s ease;
  position: relative;
}

.upload-progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(200%); }
}

.upload-progress-text {
  text-align: center;
  font-size: 12px;
  color: #5f6368;
  margin-top: 4px;
}

/* Toolbar styles */
.toolbar {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.upload-label, .btn {
  display: inline-flex;
  align-items: center;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  text-decoration: none;
  transition: all 0.2s;
  gap: 6px;
}

.upload-label {
  background: #1a73e8;
  color: white;
}

.upload-label:hover {
  background: #1557b0;
}

.upload-label input {
  display: none;
}

.btn-create {
  background: #34a853;
  color: white;
}

.btn-create:hover {
  background: #2d8f47;
}

.storage-bar-wrap {
  margin-top: 8px;
}

.storage-bar-bg {
  width: 100%;
  height: 4px;
  background: #e8eaed;
  border-radius: 2px;
  overflow: hidden;
}

.storage-bar-used {
  height: 100%;
  background: #1a73e8;
  transition: width 0.5s;
}

.breadcrumbs {
  display: flex;
  align-items: center;
  margin-bottom: 16px;
  font-size: 14px;
  color: #5f6368;
  overflow-x: auto;
  white-space: nowrap;
  padding-bottom: 4px;
}

.breadcrumbs::-webkit-scrollbar {
  height: 4px;
}

.breadcrumbs::-webkit-scrollbar-track {
  background: transparent;
}

.breadcrumbs::-webkit-scrollbar-thumb {
  background: #dadce0;
  border-radius: 2px;
}

.breadcrumbs span {
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  flex-shrink: 0;
}

.breadcrumbs span:hover:not(.breadcrumb-current) {
  background: #f1f3f4;
}

.breadcrumb-current {
  color: #202124;
  font-weight: 500;
}

/* Drop area */
.drop-area {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(26, 115, 232, 0.1);
  border: 3px dashed #1a73e8;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: #1a73e8;
  z-index: 1000;
  backdrop-filter: blur(4px);
  text-align: center;
  padding: 20px;
}

/* File list - Desktop styles */
.file-list {
  width: 100%;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border-collapse: collapse;
}

.file-list th {
  background: #f8f9fa;
  padding: 12px 16px;
  text-align: left;
  font-weight: 500;
  color: #5f6368;
  border-bottom: 1px solid #e0e0e0;
}

.file-list td {
  padding: 12px 16px;
  border-bottom: 1px solid #f1f3f4;
  vertical-align: middle;
}

.file-list tr:last-child td {
  border-bottom: none;
}

.file-list tr:hover {
  background: #f8f9fa;
}

.file-icon {
  font-size: 20px;
  margin-right: 12px;
  vertical-align: middle;
}

.folder-link, .file-link {
  color: #1a73e8;
  text-decoration: none;
  cursor: pointer;
  word-break: break-word;
}

.folder-link:hover, .file-link:hover {
  text-decoration: underline;
}

.action-group {
  display: flex;
  gap: 8px;
}

.btn-action {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: #5f6368;
  transition: all 0.2s;
}

.btn-action:hover {
  background: #f1f3f4;
}

.btn-delete:hover {
  color: #ea4335;
  background: #fce8e6;
}

.btn-download:hover {
  color: #1a73e8;
  background: #e8f0fe;
}

/* Mobile File List */
.mobile-file-list {
  display: none;
}

.mobile-file-item {
  background: white;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}

.mobile-file-item:active {
  transform: scale(0.98);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.mobile-file-header {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
}

.mobile-file-name {
  flex: 1;
  margin-left: 8px;
  font-weight: 500;
  word-break: break-word;
}

.mobile-file-actions {
  display: flex;
  gap: 4px;
  margin-left: 8px;
}

.mobile-file-meta {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #5f6368;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #f1f3f4;
}

.empty-note {
  text-align: center;
  padding: 60px 20px;
  color: #5f6368;
  font-size: 16px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Modal styles */
.modal-bg {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

.modal {
  background: white;
  border-radius: 8px;
  padding: 24px;
  min-width: 400px;
  max-width: 90vw;
  width: 100%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.modal-title {
  font-size: 18px;
  font-weight: 500;
  margin-bottom: 16px;
  color: #202124;
  display: flex;
  align-items: center;
  gap: 8px;
}

.modal input {
  width: 100%;
  padding: 12px;
  border: 1px solid #dadce0;
  border-radius: 4px;
  font-size: 14px;
  margin-bottom: 16px;
  box-sizing: border-box;
}

.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.btn-primary {
  background: #1a73e8;
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-cancel {
  background: transparent;
  color: #1a73e8;
  padding: 8px 16px;
  border: 1px solid #dadce0;
  border-radius: 4px;
  cursor: pointer;
}

/* Toast notifications */
#toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 3000;
}

.toast {
  background: #323232;
  color: white;
  padding: 12px 16px;
  border-radius: 4px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  animation: toastSlideIn 0.3s ease-out;
  max-width: calc(100vw - 40px);
}

.toast-success { background: #4caf50; }
.toast-error { background: #f44336; }

.toast.fade-out {
  animation: toastSlideOut 0.6s ease-out forwards;
}

@keyframes toastSlideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes toastSlideOut {
  to { transform: translateX(100%); opacity: 0; }
}

/* Upload queue - Desktop */
.upload-queue {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 300px;
  max-height: 400px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  overflow: hidden;
  z-index: 2500;
  display: none;
}

.upload-queue-header {
  background: #1a73e8;
  color: white;
  padding: 12px 16px;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.upload-queue-body {
  max-height: 300px;
  overflow-y: auto;
}

.upload-item {
  padding: 12px 16px;
  border-bottom: 1px solid #f1f3f4;
}

.upload-item:last-child {
  border-bottom: none;
}

.upload-item-name {
  font-size: 14px;
  color: #202124;
  margin-bottom: 4px;
  word-break: break-all;
}

.upload-item-progress {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: #5f6368;
}

.upload-item-bar {
  flex: 1;
  height: 4px;
  background: #e8eaed;
  border-radius: 2px;
  overflow: hidden;
}

.upload-item-fill {
  height: 100%;
  background: #1a73e8;
  border-radius: 2px;
  transition: width 0.3s;
}

.upload-status-success { color: #4caf50; }
.upload-status-error { color: #f44336; }

/* ===== MOBILE RESPONSIVE ===== */
@media (max-width: 768px) {
  body {
    font-size: 16px; /* Tăng font size cho mobile */
  }

  .drive-header {
    padding: 12px 16px;
  }

  .header-title {
    font-size: 18px;
  }

  .main-content {
    padding: 16px;
  }

  /* Toolbar mobile */
  .toolbar {
    gap: 8px;
  }

  .upload-label, .btn {
    padding: 12px 16px;
    font-size: 16px;
    min-height: 48px; /* Touch target size */
  }

  .upload-label .mdi,
  .btn .mdi {
    font-size: 20px;
  }

  /* Storage bar */
  #storageBar {
    font-size: 14px;
  }

  /* Hide desktop file list, show mobile version */
  .file-list {
    display: none;
  }

  .mobile-file-list {
    display: block;
  }

  .mobile-file-item .file-icon {
    font-size: 24px;
  }

  .mobile-file-name {
    font-size: 16px;
    line-height: 1.3;
  }

  .btn-action {
    width: 40px;
    height: 40px;
    font-size: 18px;
  }

  /* Upload progress bar mobile */
  .upload-progress-container {
    padding: 16px;
  }

  .upload-progress-title {
    font-size: 16px;
  }

  .upload-progress-bar {
    height: 8px;
  }

  .upload-progress-text {
    font-size: 14px;
    margin-top: 8px;
  }

  /* Toast mobile */
  #toast-container {
    top: 10px;
    right: 10px;
    left: 10px;
  }

  .toast {
    font-size: 16px;
    padding: 16px;
  }

  /* Modal mobile */
  .modal-bg {
    padding: 16px;
  }

  .modal {
    min-width: unset;
    padding: 20px;
  }

  .modal-title {
    font-size: 20px;
  }

  .modal input {
    padding: 16px;
    font-size: 16px;
  }

  .btn-primary,
  .btn-cancel {
    padding: 12px 20px;
    font-size: 16px;
    min-height: 48px;
  }

  /* Upload queue mobile - full width at bottom */
  .upload-queue {
    bottom: 0;
    right: 0;
    left: 0;
    width: 100%;
    border-radius: 12px 12px 0 0;
    max-height: 50vh;
  }

  .upload-queue-header {
    padding: 16px;
    font-size: 16px;
  }

  .upload-item {
    padding: 16px;
  }

  .upload-item-name {
    font-size: 16px;
    margin-bottom: 8px;
  }

  .upload-item-progress {
    font-size: 14px;
  }

  .upload-item-bar {
    height: 6px;
  }

  /* Drop area mobile */
  .drop-area {
    font-size: 18px;
    padding: 40px 20px;
  }

  /* Empty note mobile */
  .empty-note {
    padding: 40px 20px;
    font-size: 16px;
  }

  /* Breadcrumbs mobile */
  .breadcrumbs {
    font-size: 16px;
    margin-bottom: 20px;
  }

  .breadcrumbs span {
    padding: 8px 12px;
  }
}

/* Small mobile screens */
@media (max-width: 480px) {
  .toolbar {
    flex-direction: column;
    align-items: stretch;
  }

  .upload-label,
  .btn {
    justify-content: center;
    width: 100%;
  }

  .mobile-file-actions {
    flex-direction: column;
    gap: 8px;
  }

  .modal-actions {
    flex-direction: column;
    gap: 8px;
  }

  .modal-actions .btn-primary,
  .modal-actions .btn-cancel {
    width: 100%;
    justify-content: center;
  }
}

/* Landscape mobile */
@media (max-width: 768px) and (orientation: landscape) {
  .upload-queue {
    max-height: 40vh;
  }

  .drive-header {
    position: static;
  }
}
  </style>
  <link rel="icon" href="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png">
</head>
<body>
  <!-- Upload Progress Bar -->
  <div class="upload-progress-container" id="uploadProgressBar">
    <div class="upload-progress-header">
      <div class="upload-progress-title">
        <span class="mdi mdi-cloud-upload"></span>
        <span id="uploadProgressTitle">Đang tải lên...</span>
      </div>
      <button class="upload-progress-close" onclick="hideUploadProgress()">
        <span class="mdi mdi-close"></span>
      </button>
    </div>
    <div class="upload-progress-bar">
      <div class="upload-progress-fill" id="uploadProgressFill" style="width: 0%"></div>
    </div>
    <div class="upload-progress-text" id="uploadProgressText">Chuẩn bị...</div>
  </div>

  <div class="drive-header">
    <img src="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png" alt="Drive" style="width:32px;height:32px;margin-right:13px;">
    <span class="header-title">Mini Google Drive</span>
  </div>
  
  <div class="main-content">
    <div class="toolbar">
      <label class="upload-label upload-file" title="Tải lên tệp">
        <span class="mdi mdi-upload"></span> Tải lên tệp
        <input type="file" id="fileInput" multiple onchange="handleFileSelect(this.files, currentFolderId)">
      </label>
      <label class="upload-label upload-folder" title="Tải lên thư mục">
        <span class="mdi mdi-folder-upload"></span> Tải lên thư mục
        <input type="file" id="folderInput" webkitdirectory directory multiple onchange="handleFolderSelect(this.files, currentFolderId)">
      </label>
      <button class="btn btn-create" onclick="promptCreateFolder()">
        <span class="mdi mdi-folder-plus-outline"></span> Tạo thư mục
      </button>
    </div>
    
    <div id="storageBar" style="margin: 15px 0 18px 0; font-size:15px;"></div>
    <div class="breadcrumbs" id="breadcrumbs"></div>
    <div class="drop-area" id="dropArea">
      <div>
        <div style="margin-bottom: 16px;">
          <span class="mdi mdi-cloud-upload" style="font-size: 48px;"></span>
        </div>
        Kéo & thả tệp/thư mục vào đây để tải lên
      </div>
    </div>
    
    <!-- Desktop File List -->
    <table class="file-list" id="fileTable">
      <thead>
        <tr>
          <th class="col-name">Tên</th>
          <th class="col-time">Ngày cập nhật</th>
          <th class="col-size">Dung lượng</th>
          <th class="col-action">Tác vụ</th>
        </tr>
      </thead>
      <tbody id="fileListBody"></tbody>
    </table>

    <!-- Mobile File List -->
    <div class="mobile-file-list" id="mobileFileList"></div>
    
    <div class="empty-note" id="emptyNote" style="display: none;">
      <div style="margin-bottom: 16px;">
        <span class="mdi mdi-folder-outline" style="font-size: 48px; color: #dadce0;"></span>
      </div>
      Chưa có tệp hay thư mục nào
    </div>
  </div>
  
  <div id="toast-container"></div>
  
  <!-- Upload Queue -->
  <div class="upload-queue" id="uploadQueue">
    <div class="upload-queue-header">
      <span><span class="mdi mdi-cloud-upload"></span> Đang tải lên</span>
      <button onclick="hideUploadQueue()" style="background:none;border:none;color:white;cursor:pointer;">
        <span class="mdi mdi-close"></span>
      </button>
    </div>
    <div class="upload-queue-body" id="uploadQueueBody"></div>
  </div>

<script>
// ==== Globals ====
const MY_QUOTA_GB = 0;
let currentFolderId = null;
let breadcrumbs = [];
let folderNameMap = {};
let uploadQueue = [];
let accessToken = null;
let tokenExpiry = null;
let globalUploadProgress = { current: 0, total: 0, currentFile: '' };

// ==== Device detection ====
function isMobile() {
  return window.innerWidth <= 768;
}

// ==== Global Upload Progress Bar ====
function showUploadProgress() {
  document.getElementById('uploadProgressBar').classList.add('show');
}

function hideUploadProgress() {
  document.getElementById('uploadProgressBar').classList.remove('show');
  globalUploadProgress = { current: 0, total: 0, currentFile: '' };
}

function updateGlobalUploadProgress(current, total, currentFile, progress = 0) {
  globalUploadProgress.current = current;
  globalUploadProgress.total = total;
  globalUploadProgress.currentFile = currentFile;
  
  const overallProgress = total > 0 ? ((current - 1 + progress / 100) / total * 100) : 0;
  
  document.getElementById('uploadProgressFill').style.width = overallProgress + '%';
  document.getElementById('uploadProgressTitle').textContent = `Đang tải lên (${current}/${total})`;
  document.getElementById('uploadProgressText').textContent = `${currentFile} - ${progress.toFixed(0)}%`;
  
  if (current >= total && progress >= 100) {
    setTimeout(() => {
      hideUploadProgress();
    }, 2000);
  }
}

// ==== Toast notifications ====
function showToast(msg, type = 'info') {
  const toastContainer = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `<span class="mdi ${type === 'success' ? 'mdi-check-circle-outline' : type === 'error' ? 'mdi-alert-circle-outline' : 'mdi-information-outline'}"></span> ${msg}`;
  toastContainer.appendChild(toast);
  setTimeout(() => {
    toast.classList.add('fade-out');
    setTimeout(() => toast.remove(), 600);
  }, isMobile() ? 3000 : 2300);
}

// ==== Access Token ====
async function getAccessToken() {
  if (accessToken && tokenExpiry && Date.now() < tokenExpiry - 300000) {
    return accessToken;
  }
  
  try {
    const res = await fetch('/get-upload-token', { method: 'POST' });
    const data = await res.json();
    
    if (data.accessToken) {
      accessToken = data.accessToken;
      tokenExpiry = data.expiresIn;
      return accessToken;
    }
    throw new Error('Không nhận được access token');
  } catch (err) {
    console.error('Lỗi lấy access token:', err);
    throw err;
  }
}

// ==== Direct Upload ====
async function getAccessToken() {
  if (accessToken && tokenExpiry && Date.now() < tokenExpiry - 300000) {
    return accessToken;
  }

  try {
    const res = await fetch('/get-upload-token', { method: 'POST' });
    const data = await res.json();

    if (data.accessToken) {
      accessToken = data.accessToken;
      // expiresIn thường trả về giây → phải cộng với Date.now()
      tokenExpiry = Date.now() + data.expiresIn * 1000;
      return accessToken;
    }
    throw new Error('Không nhận được access token');
  } catch (err) {
    console.error('Lỗi lấy access token:', err);
    throw err;
  }
}
